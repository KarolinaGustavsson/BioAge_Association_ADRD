---
title: "Inspecting data"
output: html_notebook
---

Setting up everything
```{r}
options(repos = "http://nexus.ki.se/repository/cran.r-project.org")
.libPaths("W:/C6_AmorisGuest/Sara Hagg/Karolina Gustavsson/shun_trial/lib")

library(tidyverse)
library(flexsurv)
library(haven)
library(survival)
library(broom)
library(ggplot2)
library(checkmate) 
library(htmlTable)
library(survey)
library(tidyr)
library(dplyr)
library(psych)
```

Read the data
```{r}
amoris <- read_sas("W:/C6_AmorisGuest/Sara Hagg/Karolina Gustavsson/Data/StudyPop.sas7bdat")

#Optional
#load("W:/C6_AmorisGuest/Sara Hagg/Karolina Gustavsson/BioAge-master/BioAge/data/NHANES3.rda")
```

Biomarkers
```{r}
#select our 17 biomarkers
biomarkers <- c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")
```


Distribution pre processesing 
```{r}
library(ggplot2)
library(tidyr)

long_data <- gather(amoris, key = "biomarker", value = "value", biomarkers)

# Plot histograms
ggplot(long_data, aes(x = value)) +
  geom_histogram(bins = 50, fill = "blue", color = "black") +
  facet_wrap(~ biomarker, scales = "free", ncol = 4) +
  theme_minimal() +
  labs(x = "Value", y = "Frequency", title = "Histograms of Biomarkers")

rm(long_data)
```
Density plots before 
```{r}
library(ggplot2)
library(tidyr)

long_data <- gather(amoris, key = "biomarker", value = "value", biomarkers)

# Plot density plots
ggplot(long_data, aes(x = value, fill = biomarker)) +
  geom_density(alpha = 0.7,adjust=4) +
  facet_wrap(~ biomarker, scales = "free", ncol = 4) +
  theme_minimal() +
  labs(x = "Value", y = "Density", title = "Density Plots of Biomarkers") +
  theme(legend.position = "none") # Hides the legend, adjust as needed

rm(long_data)
```

Scatter plot (with 10% of the cohort)
```{r}

# Calculate 10% of the number of patients
sample_size <- floor(0.10 * nrow(amoris))

# Randomly sample patient rows
sampled_AMORIS <- amoris[sample(nrow(amoris), size = sample_size), ]

# Loop through each biomarker and create a scatter plot
for (biomarker in biomarkers) {
  long_data <- sampled_AMORIS %>%
    select(Alder, all_of(biomarker)) %>%
    pivot_longer(
      cols = -Alder, # Exclude the age column from reshaping
      names_to = "biomarker",
      values_to = "value"
    )

  # Create scatter plot for each biomarker
  plot <- ggplot(long_data, aes(x = Alder, y = value)) +
    geom_point(alpha = 0.1, size = 0.1) +
    theme_minimal() +
    labs(x = "Age", y = biomarker, title = paste("Scatter Plot of", biomarker, "Against Age"))
  
  print(plot) # Print the plot
}

rm(sampled_AMORIS)
rm(long_data)
rm(biomarker)
rm(number_of_biomarkers)
rm(sample_size)
```



Correlation with age for entire cohort
```{r}
correlations_spearman <- cor(amoris$Alder, amoris[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "spearman", use = "complete.obs")
correlations_pearson <- cor(amoris$Alder, amoris[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "pearson", use = "complete.obs")

print(correlations_spearman)
print(correlations_pearson)

#Over 0.1 Spearman:
#S_Alb, S_Krea, TC, TG, S_K, S_P, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fs_Gluk

#Over 0.15 Spearman:
#S_Alb, TC, TG, S_P, S_Urea, S_LD, S_Alp, S_Urat, S_FAMN, S_Hapt, fs_Gluk

#Over 0.2 Spearman:
#S_Alb, TC, TG, S_Urea, S_LD, S_Hapt, fs_Gluk

#Over 0.1 Pearson:
#S_Alb, S_Krea, TC, TG, S_K, S_P, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fs_Gluk

#Over 0.15 Pearson:
#S_Alb, TC, S_P, S_Urea, S_LD, S_Urat, S_FAMN, S_Hapt, fs_Gluk

#Over 0.2 Pearson:
#S_Alb, TC, S_Urea, S_LD, fs_Gluk
```


Correlation separately by sex
```{r}
# Filter data based on the 'Kon' column
amoris_men <- amoris[amoris$Kon == 1, ]
amoris_women <- amoris[amoris$Kon == 2, ]


## check pearson correlation
# Calculate Pearson correlations between Age and biomarkers
correlations_pearson_m <- cor(amoris_men$Alder, amoris_men[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "pearson", use = "complete.obs")
correlations_spearman_m <- cor(amoris_men$Alder, amoris_men[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "spearman", use = "complete.obs")
correlations_pearson_f <- cor(amoris_women$Alder, amoris_women[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "pearson", use = "complete.obs")
correlations_spearman_f <- cor(amoris_women$Alder, amoris_women[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "spearman", use = "complete.obs")
print("correlations_pearson_m:")
print(correlations_pearson_m)#Fe_maet, fS_TIBIC, fS_Jaern, S_Alp are under abs(0.1)
print("correlations_spearman_m:")
print(correlations_spearman_m)#Fe_maet, fS_TIBIC, fS_Jaern, S_Alp are under abs(0.1)
print("correlations_pearson_f:")
print(correlations_pearson_f)#S_P,Fe_maet,S_Ca (depends on rounding), fS_Jarn, are under abs(0.1)
print("correlations_spearman_f:")
print(correlations_spearman_f)#S_P,Fe_maet, S_Ca (depends on rounding), fS_Jarn, are under abs(0.1)

#print(abs(correlations_pearson_m) > 0.1)

#"S_Alb", "S_Krea", "TC", "TG", "S_K", "S_Urea", "S_LD", "S_Ca", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk": the ones over 0.1 rounded up, separatley for each sex

#pearson_m > 0.1: S_Alb, S_Krea, TC, TG, S_K, S_P, S_Urea, S_LD, S_Ca, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#pearson_m > 0.15: S_Alb, S_Krea, TC, S_P, S_Urea, S_Ca, S_Hapt, fS_Gluk
#pearson_m > 0.2: S_Alb, TC, S_Urea, S_Ca, fS_Gluk

#spearman_m > 0.1: S_Alb, S_Krea, TC, TG, S_K, S_P, S_Urea, S_LD, S_Ca, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#spearman_m > 0.15: S_Alb, S_Krea, TC, TG, S_P, S_Urea, S_Ca, S_Hapt, fS_Gluk
#spearman_m > 0.2: S_Alb, TC, S_P, S_Urea, S_Ca, S_Hapt

#pearson_f >0.1: S_Alb, S_Krea, TC, TG, S_K, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#pearson_f > 0.15: S_Alb, S_Krea, TC, TG, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#pearson_f > 0.2: S_Alb, TC, TG, S_Urea, S_LD, S_Alp, S_Urat, fS_Gluk

#spearman_f >0.1: S_Alb, S_Krea, TC, TG, S_K, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#spearman_f > 0.15: S_Alb, S_Krea, TC, TG, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#spearman_f > 0.2: S_Alb, TC, TG, S_Urea, S_LD, S_Alp, S_Urat, fS_Gluk

```
```{r}
rm(amoris_men)
rm(amoris_women)
rm(correlations_pearson)
rm(correlations_pearson_m)
rm(correlations_pearson_f)
rm(correlations_spearman)
rm(correlations_spearman_m)
rm(correlations_spearman_f)
```

Summary statistics for cont. variables
```{r}
# Identify continuous (numeric) variables
continuous_vars <- sapply(amoris, is.numeric) & !sapply(amoris, is.factor)

# Custom summary function including standard deviation
custom_summary <- function(x) {
  c(Mean = mean(x, na.rm = TRUE),
    SD = sd(x, na.rm = TRUE),
    Median = median(x, na.rm = TRUE),
    '1st Qu' = quantile(x, probs = 0.25, na.rm = TRUE),
    '3rd Qu' = quantile(x, probs = 0.75, na.rm = TRUE),
    Min = min(x, na.rm = TRUE),
    Max = max(x, na.rm = TRUE))
}

# Apply custom summary function to each continuous variable
summary_stats <- lapply(amoris[continuous_vars], custom_summary)

# Convert the list to a dataframe for a cleaner presentation
summary_df <- do.call(rbind, summary_stats)

# View the summary statistics
print(summary_df)
```


========================================================================================================
PROCESSING
========================================================================================================



Filtering out outliers (5 Standard deviations) ##### This should be changed to sep per sex
```{r}
library(dplyr)

AMORIS <- amoris %>%
  group_by(Kon) %>%
  filter(
    if_else(
      Kon == 1, 
      across(all_of(biomarkers), ~ .x > mean(.x, na.rm = TRUE) - 5 * sd(.x, na.rm = TRUE) & .x < mean(.x, na.rm = TRUE) + 5 * sd(.x, na.rm = TRUE)),
      across(all_of(biomarkers), ~ .x > mean(.x, na.rm = TRUE) - 5 * sd(.x, na.rm = TRUE) & .x < mean(.x, na.rm = TRUE) + 5 * sd(.x, na.rm = TRUE))
    )
  ) %>%
  ungroup()

AMORIS <- AMORIS[complete.cases(AMORIS[, biomarkers]), ]
```

Checking histograms again
```{r}
library(ggplot2)
library(tidyr)

long_data <- gather(AMORIS, key = "biomarker", value = "value", biomarkers)

# Plot histograms
ggplot(long_data, aes(x = value)) +
  geom_histogram(bins = 50, fill = "blue", color = "black") +
  facet_wrap(~ biomarker, scales = "free", ncol = 4) +
  theme_minimal() +
  labs(x = "Value", y = "Frequency", title = "Histograms of Biomarkers")

rm(long_data)
```
Checking density plots again
```{r}
library(ggplot2)
library(tidyr)

long_data <- gather(AMORIS, key = "biomarker", value = "value", biomarkers)

# Plot density plots
ggplot(long_data, aes(x = value, fill = biomarker)) +
  geom_density(alpha = 0.7,adjust=4) +
  facet_wrap(~ biomarker, scales = "free", ncol = 4) +
  theme_minimal() +
  labs(x = "Value", y = "Density", title = "Density Plots of Biomarkers") +
  theme(legend.position = "none") # Hides the legend, adjust as needed

rm(long_data)
```

Correlation with age for entire cohort
```{r}
correlations_spearman <- cor(AMORIS$Alder, AMORIS[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "spearman", use = "complete.obs")
correlations_pearson <- cor(AMORIS$Alder, AMORIS[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "pearson", use = "complete.obs")

print(correlations_spearman)
print(correlations_pearson)

#Over 0.1 Spearman:
#S_Alb, S_Krea, TC, TG, S_K, S_P, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fs_Gluk

#Over 0.15 Spearman:
#S_Alb, TC, TG, S_P, S_Urea, S_LD, S_Alp, S_Urat, S_Hapt, fs_Gluk
# NOT S_FAMN

#Over 0.2 Spearman:
#S_Alb, TC, TG, S_Urea, S_LD, fs_Gluk

#Over 0.1 Pearson:
#S_Alb, S_Krea, TC, TG, S_K, S_P, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fs_Gluk

#Over 0.15 Pearson:
#S_Alb, TC, TG, S_P, S_Urea, S_LD, S_Alp, S_Urat, S_Hapt, fs_Gluk

#Over 0.2 Pearson:
#S_Alb, TC, S_Urea, S_LD, fs_Gluk

```

Correlation separately per sex
```{r}
# Filter data based on the 'Kon' column
amoris_men <- amoris[amoris$Kon == 1, ]
amoris_women <- amoris[amoris$Kon == 2, ]


## check pearson correlation
# Calculate Pearson correlations between Age and biomarkers
correlations_pearson_m <- cor(amoris_men$Alder, amoris_men[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "pearson", use = "complete.obs")
correlations_spearman_m <- cor(amoris_men$Alder, amoris_men[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "spearman", use = "complete.obs")
correlations_pearson_f <- cor(amoris_women$Alder, amoris_women[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "pearson", use = "complete.obs")
correlations_spearman_f <- cor(amoris_women$Alder, amoris_women[, c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_P", "Fe_maet", "S_Urea", "S_LD", "S_Ca", "fS_TIBC", "fS_Jaern", "S_Alp", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")], method = "spearman", use = "complete.obs")
print(correlations_pearson_m)#Fe_maet, fS_TIBIC, fS_Jaern, S_Alp are under abs(0.1)
print(correlations_spearman_m)#Fe_maet, fS_TIBIC, fS_Jaern, S_Alp are under abs(0.1)
print(correlations_pearson_f)#S_P,Fe_maet,S_Ca, fS_Jarn, are under abs(0.1)
print(correlations_spearman_f)#S_P,Fe_maet, S_Ca, fS_Jarn, are under abs(0.1)

#print(abs(correlations_pearson_m) > 0.1)

#pearson_m > 0.1: S_Alb, S_Krea, TC, TG, S_K, S_P, S_Urea, S_LD, S_Ca, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#pearson_m > 0.15: S_Alb, S_Krea, TC, S_P, S_Urea, S_Ca, S_Hapt, fS_Gluk
#pearson_m > 0.2: S_Alb, TC, S_P, S_Urea, S_Ca, fS_Gluk

#spearman_m > 0.1: S_Alb, S_Krea, TC, TG, S_K, S_P, S_Urea, S_LD, S_Ca, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#spearman_m > 0.15: S_Alb, TC, TG, S_P, S_Urea, S_Ca, S_Hapt, fS_Gluk
#spearman_m > 0.2: S_Alb, TC, S_P, S_Urea, S_Ca, S_Hapt, fS_Gluk

#pearson_f >0.1: S_Alb, S_Krea, TC, TG, S_K, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#pearson_f > 0.15: S_Alb, S_Krea, TC, TG, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#pearson_f > 0.2: S_Alb, TC, TG, S_Urea, S_LD, S_Alp, S_Urat, fS_Gluk

#spearman_f >0.1: S_Alb, S_Krea, TC, TG, S_K, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#spearman_f > 0.15: S_Alb, S_Krea, TC, TG, S_Urea, S_LD, fS_TIBC, S_Alp, S_Urat, S_FAMN, S_Hapt, fS_Gluk
#spearman_f > 0.2: S_Alb, TC, TG, S_Urea, S_LD, S_Alp, S_Urat, fS_Gluk
```

```{r}
rm(amoris_men)
rm(amoris_women)
rm(correlations_pearson)
rm(correlations_pearson_m)
rm(correlations_pearson_f)
rm(correlations_spearman)
rm(correlations_spearman_m)
rm(correlations_spearman_f)
```


Now we know which biomarkers to use in the BA analysis
```{r}
#We will now redefine our biomarkers to this combination
#over both 0.10 separately for both men and women, 25-75:
#biomarkers = c("S_Alb", "S_Krea", "TC", "TG", "S_Urea", "S_LD", "S_Ca", "S_FAMN", "S_Hapt", "fS_Gluk")

##new
#biomarkers = c("S_Alb", "S_Krea", "TC", "TG", "S_K", "S_Urea", "S_LD", "S_Ca", "S_Urat", "S_FAMN", "S_Hapt", "fS_Gluk")
```

Scatter plot (with 10% of the cohort)
```{r}
# Calculate 10% of the number of patients
sample_size <- floor(0.10 * nrow(AMORIS))

# Randomly sample patient rows
sampled_AMORIS <- AMORIS[sample(nrow(AMORIS), size = sample_size), ]

# Loop through each biomarker and create a scatter plot
for (biomarker in biomarkers) {
  long_data <- sampled_AMORIS %>%
    select(Alder, all_of(biomarker)) %>%
    pivot_longer(
      cols = -Alder, # Exclude the age column from reshaping
      names_to = "biomarker",
      values_to = "value"
    )

  # Create scatter plot for each biomarker
  plot <- ggplot(long_data, aes(x = Alder, y = value)) +
    geom_point(alpha = 0.1, size = 0.1) +
    theme_minimal() +
    labs(x = "Age", y = biomarker, title = paste("Scatter Plot of", biomarker, "Against Age"))
  
  print(plot) # Print the plot
}

rm(sampled_AMORIS)
rm(long_data)
rm(biomarker)
rm(number_of_biomarkers)
rm(sample_size)
```

Figuring out the size of our training set
```{r}
### Training on a amoris subset the same size as nhanes 3, in the range 25-75
## Figure out number of nhanes participants and participants in range 25-50
load("W:/C6_AmorisGuest/Sara Hagg/Karolina Gustavsson/BioAge-master/BioAge/data/NHANES3.rda")
# Checking the size of 25-75, and 30-75 NHANES people  
# lets check the size!
count_df <- NHANES3[NHANES3$age >= 30 & NHANES3$age <= 75, ]
# Count the number of rows in the filtered dataframe
num_rows <- nrow(count_df)
num_rows
# okay so number of people in 25-75 in nhanes3 is 14377
# okay so number of people in 30-75 in nhanes3 is 12535, which is what they trained on, we also want this amount
```

Let's look at the other variables:
- Economic variables
- BMI
- Education level 

Let's start with economic variables: DispInk, DispInkFam, DispInkKE, ArbInk (before dementia)
```{r}
library(ggplot2)
library(tidyr)

# Reshaping the data to long format for easy plotting
AMORIS_long <- AMORIS %>%
  select(DispInk, DispInkKE, DispInkFam, ArbInk) %>%
  pivot_longer(cols = everything(), names_to = "IncomeType", values_to = "Income")

# Density plot of raw data
ggplot(AMORIS_long, aes(x = Income, fill = IncomeType)) +
  geom_density(alpha = 0.5,na.rm = TRUE) +
  labs(title = "Density Plot of Various Income Types", x = "Income", y = "Density") +
  theme_minimal()

print("done")
```
Okay so we have some very extreme outliers, we can not use average/STD, we have to use median/MAD
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)

# Assuming these are your income variables
income_vars <- c("DispInk", "DispInkKE", "DispInkFam", "ArbInk")

# Reshape and then filter outliers based on median and MAD
AMORIS_filtered <- AMORIS %>%
  select(all_of(income_vars)) %>%
  pivot_longer(cols = everything(), names_to = "IncomeType", values_to = "Income") %>%
  group_by(IncomeType) %>%
  mutate(
    median_income = median(Income, na.rm = TRUE),
    mad_income = mad(Income, constant = 1, na.rm = TRUE)  # MAD as a robust measure
  ) %>%
  filter(between(Income, median_income - 5 * mad_income, median_income + 5 * mad_income)) %>%
  ungroup() %>%
  select(-median_income, -mad_income)

# Density plot of data with outliers removed
ggplot(AMORIS_filtered, aes(x = Income, fill = IncomeType)) +
  geom_density(alpha = 0.5, na.rm = TRUE) +
  labs(title = "Density Plot of Various Income Types (Outliers Removed)", x = "Income", y = "Density") +
  theme_minimal()

```

BMI
```{r}
sum(!is.na(to1po2$BMI)) #not that many cases 32 685

ggplot(AMORIS, aes(x = BMI)) +
  geom_density(fill = "blue", alpha = 0.5, na.rm = TRUE) +
  labs(title = "Density Plot of BMI", x = "BMI", y = "Density") +
  theme_minimal()
```
Distribution per age
```{r}
ggplot(AMORIS, aes(x = Alder)) + 
  geom_density(fill = "blue", alpha = 0.5) + 
  labs(title = "Density Plot of Ages", x = "Age", y = "Density") +
  theme_minimal()
```


Education level
```{r}
library(ggplot2)

# Convert the education level to a factor, treating empty strings as a separate level
AMORIS$UtbNiva <- factor(AMORIS$UtbNiva, levels = unique(AMORIS$UtbNiva))

# Create a bar plot for education levels
ggplot(AMORIS, aes(x = UtbNiva)) +
  geom_bar(fill = "blue", alpha = 0.7) +
  labs(title = "Histogram of Education Level", x = "Education Level", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Adjust the x-axis text angle for better readability

```
Summary statistics 
```{r}
# Identify continuous (numeric) variables
continuous_vars <- sapply(AMORIS, is.numeric) & !sapply(AMORIS, is.factor)

# Custom summary function including standard deviation
custom_summary <- function(x) {
  c(Mean = mean(x, na.rm = TRUE),
    SD = sd(x, na.rm = TRUE),
    Median = median(x, na.rm = TRUE),
    '1st Qu' = quantile(x, probs = 0.25, na.rm = TRUE),
    '3rd Qu' = quantile(x, probs = 0.75, na.rm = TRUE),
    Min = min(x, na.rm = TRUE),
    Max = max(x, na.rm = TRUE))
}

# Apply custom summary function to each continuous variable
summary_stats <- lapply(AMORIS[continuous_vars], custom_summary)

# Convert the list to a dataframe for a cleaner presentation
summary_df <- do.call(rbind, summary_stats)

# View the summary statistics
print(summary_df)
```


```{r}
rm(AMORIS_long)
rm(AMORIS_filtered)
rm(income_vars)
rm(agevar)
rm(agevar_ap)
rm(label)
rm(label_ap)
```

Checking out SveDem data
```{r}
SveDem <- read_sas("W:/C6_AmorisGuest/Sara Hagg/Karolina Gustavsson/Data/SveDem.sas7bdat")
SveDem_format <- read_sas("W:/C6_AmorisGuest/Sara Hagg/Karolina Gustavsson/Data/SveDem_fomats.sas7bdat")
```

Checking out the Svedem unique codes
```{r}
number_of_unique_strings <- length(unique(SveDem$Dementia))
print(number_of_unique_strings) # 26 unique codes, it says 27 but one is the empty chr str
unique_strings <- unique(SveDem$Dementia)
print(unique_strings)
```

Do we have entires in SveDem where Dementia diagnosis is not added to amoris?
```{r}
# Step 1: Find Matching IDs
matching_ids <- intersect(amoris$Id, SveDem$Id)

# Step 2: Merge Data based on Matching IDs
merged_data <- merge(amoris[amoris$Id %in% matching_ids, c("Id", "Dementia")], 
                     SveDem[SveDem$Id %in% matching_ids, c("Id", "Dementia")], 
                     by.x = "Id", by.y = "Id")

# Step 3: Compare 'Dementia' Columns
# Assuming the Dementia columns are named Dementia.x and Dementia.y after merging
mismatches <- merged_data$Dementia.x != merged_data$Dementia.y

# Step 4: Count Mismatches
num_mismatches <- sum(mismatches)
print(paste("Number of unmatched Dementia entries:", num_mismatches))

# Okay so we already have them all, SveDem has more accurate diagnosis so we should run separate SveDem Diagnosis 
```
Optional
```{r}
rm(amoris)
rm(AMORIS)
rm(biomarkers)
```
