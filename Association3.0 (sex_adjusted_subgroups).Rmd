---
title: "Association"
output: html_notebook
---
Run Calculating_BA.Rmd first 


### Association between BA and ADRD 

Prepare variables, recoding DispInk and UtbNiva
```{r}
# Calculate median and IQR
median_income <- median(to1po2$DispInk, na.rm = TRUE)
iqr_income <- IQR(to1po2$DispInk, na.rm = TRUE)

# Define breaks based on median and IQR
# Adjust these values as needed to better categorize your data
lower_break <- median_income - iqr_income
upper_break <- median_income + iqr_income

breaks <- c(-Inf, lower_break, upper_break, Inf)

labels <- c("Low Income", "Middle Income", "High Income")

to1po2 <- to1po2 %>%
  mutate(
    income_bins = cut(DispInk, breaks = breaks, labels = labels, include.lowest = TRUE),
    income_bins = factor(income_bins, levels = labels)  # Set the levels to maintain order
  )

# Set 'Middle Income' as the reference category
to1po2$income_bins <- relevel(to1po2$income_bins, ref = "Middle Income")

# Check the distribution of the new bins
table(to1po2$income_bins)


# Education level
#to1po2$UtbNiva <- factor(to1po2$UtbNiva)
#to1po2$UtbNiva <- relevel(to1po2$UtbNiva, ref = "4")
library(dplyr)

to1po2 <- to1po2 %>%
  mutate(utbNiva = replace(UtbNiva, UtbNiva == "", NA_character_)) %>%
  mutate(NewUtbNiva = case_when(
    utbNiva %in% c('1', '2', '3') ~ '1',
    utbNiva %in% c('4', '5', '6', '7') ~ '2',
    TRUE ~ NA_character_
  )) %>%
  mutate(NewUtbNiva = factor(NewUtbNiva, levels = c('1', '2')))




# Calculate age at FirstDate in years
to1po2$AgeAtFirstDate <- as.numeric(difftime(to1po2$firstDate, to1po2$FODDATn, units = "days") / 365.25)
# Calculate age at LastDate in years
to1po2$AgeAtLastDate <- as.numeric(difftime(to1po2$lastDate, to1po2$FODDATn, units = "days") / 365.25)
```

#======== Association with ADRD and subtypes

```{r}
calc_standardized_beta <- function(model, data, covariate) {
    beta <- coef(model)[covariate]
    sd_covariate <- sd(data[[covariate]], na.rm = TRUE)
    std_beta <- beta * sd_covariate
    return(std_beta)
}

```

ADRD
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA data frame
HR_BA_adrd <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("ADRD", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N = NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, ADRD) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_adrd[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_adrd[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_adrd[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_adrd[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_adrd[row_index_gender, "N"] <- coef_gender$n
  HR_BA_adrd[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, ADRD) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_adrd[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_adrd[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_adrd[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_adrd[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_adrd[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_adrd[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

ADRD_results <- HR_BA_adrd

# Print the modified HR_BA_adrd data frame
print(HR_BA_adrd)
```
ADRD based on SveDem
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_s_adrd <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("SveDem ADRD", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_ADRD) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_s_adrd[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_s_adrd[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_s_adrd[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_s_adrd[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_s_adrd[row_index_gender, "N"] <- coef_gender$n
  HR_BA_s_adrd[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_ADRD) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_s_adrd[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_s_adrd[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_s_adrd[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_s_adrd[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_s_adrd[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_s_adrd[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

S_ADRD_results <- HR_BA_s_adrd

# Print the modified HR_BA_adrd data frame
print(HR_BA_s_adrd)
```
ADRD excluding SveDem
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_ns_adrd <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("Excluding SveDem ADRD", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_ADRD) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_ns_adrd[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_ns_adrd[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_ns_adrd[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_ns_adrd[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_ns_adrd[row_index_gender, "N"] <- coef_gender$n
  HR_BA_ns_adrd[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_ADRD) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_ns_adrd[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_ns_adrd[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_ns_adrd[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_ns_adrd[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_ns_adrd[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_ns_adrd[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

NS_ADRD_results <- HR_BA_ns_adrd

# Print the modified HR_BA_adrd data frame
print(HR_BA_ns_adrd)
```

Alzheimers broad category ie not SveDem
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_alzh <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("Alzheimers", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Alzheimers) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_alzh[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_alzh[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_alzh[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_alzh[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_alzh[row_index_gender, "N"] <- coef_gender$n
  HR_BA_alzh[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Alzheimers) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_alzh[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_alzh[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_alzh[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_alzh[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_alzh[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_alzh[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

Alzh_results <- HR_BA_alzh

# Print the modified HR_BA_adrd data frame
print(HR_BA_alzh)
```

SveDem Alzheimers 
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_s_alzh <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("SveDem Alzheimers", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_Alzheimers) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_s_alzh[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_s_alzh[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_s_alzh[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_s_alzh[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_s_alzh[row_index_gender, "N"] <- coef_gender$n
  HR_BA_s_alzh[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_Alzheimers) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_s_alzh[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_s_alzh[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_s_alzh[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_s_alzh[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_s_alzh[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_s_alzh[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

S_Alzh_results <- HR_BA_s_alzh

# Print the modified HR_BA_adrd data frame
print(HR_BA_s_alzh)
```
Alzheimers excluding SveDem
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_ns_alzh <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("Excluding SveDem Alzheimers", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_Alzheimers) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_ns_alzh[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_ns_alzh[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_ns_alzh[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_ns_alzh[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_ns_alzh[row_index_gender, "N"] <- coef_gender$n
  HR_BA_ns_alzh[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_Alzheimers) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_ns_alzh[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_ns_alzh[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_ns_alzh[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_ns_alzh[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_ns_alzh[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_ns_alzh[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

NS_Alzh_results <- HR_BA_ns_alzh

# Print the modified HR_BA_adrd data frame
print(HR_BA_ns_alzh)
```

Vascular 
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_vasc <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("Vascular Dementia", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Vascular) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_vasc[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_vasc[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_vasc[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_vasc[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_vasc[row_index_gender, "N"] <- coef_gender$n
  HR_BA_vasc[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Vascular) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_vasc[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_vasc[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_vasc[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_vasc[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_vasc[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_vasc[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

Vasc_results <- HR_BA_vasc

# Print the modified HR_BA_adrd data frame
print(HR_BA_vasc)
```

Svedem Vascular
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_s_vasc <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("SveDem Vascular Dementia", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_Vascular) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_s_vasc[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_s_vasc[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_s_vasc[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_s_vasc[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_s_vasc[row_index_gender, "N"] <- coef_gender$n
  HR_BA_s_vasc[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_Vascular) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_s_vasc[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_s_vasc[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_s_vasc[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_s_vasc[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_s_vasc[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_s_vasc[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

S_Vasc_results <- HR_BA_s_vasc

# Print the modified HR_BA_adrd data frame
print(HR_BA_s_vasc)
```
Exluding SveDem Vascular
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_ns_vasc <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("Excluding SveDem Vascular Dementia", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_Vascular) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_ns_vasc[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_ns_vasc[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_ns_vasc[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_ns_vasc[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_ns_vasc[row_index_gender, "N"] <- coef_gender$n
  HR_BA_ns_vasc[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_Vascular) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_ns_vasc[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_ns_vasc[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_ns_vasc[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_ns_vasc[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_ns_vasc[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_ns_vasc[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

NS_Vasc_results <- HR_BA_ns_vasc

# Print the modified HR_BA_adrd data frame
print(HR_BA_ns_vasc)
```

Other
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_othe <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("Other Dementia", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Other) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_othe[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_othe[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_othe[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_othe[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_othe[row_index_gender, "N"] <- coef_gender$n
  HR_BA_othe[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Other) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_othe[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_othe[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_othe[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_othe[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_othe[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_othe[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

Othe_results <- HR_BA_othe

# Print the modified HR_BA_adrd data frame
print(HR_BA_othe)
```

SveDem Other
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_s_othe <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("SveDem Other Dementia", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_other) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_s_othe[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_s_othe[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_s_othe[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_s_othe[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_s_othe[row_index_gender, "N"] <- coef_gender$n
  HR_BA_s_othe[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_other) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_s_othe[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_s_othe[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_s_othe[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_s_othe[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_s_othe[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_s_othe[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

S_Othe_results <- HR_BA_s_othe

# Print the modified HR_BA_adrd data frame
print(HR_BA_s_othe)
```
Excluding SveDem other
```{r}
# BA measures to be tested
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Correct the initialization of HR_BA_adrd data frame
HR_BA_ns_othe <- data.frame(
  BA = rep(BA_measures, each = 2),  # Repeat each BA measure twice
  outcome = rep("Excluding SveDem Other Dementia", times = length(BA_measures) * 2),
  model = rep(c("Sex-adjusted model", "Multivariable model"), times = length(BA_measures)),
  beta = NA, se = NA, HR = NA, lb = NA, ub = NA, p = NA, p_PH_BA = NA, global_p_PH_BA = NA,
  concordance = NA, N=NA, std_beta = NA  # Add a column for the concordance index
)

for (j in 1:length(BA_measures)) {
  # Sex-adjusted model
  fit_gender <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_other) ~", BA_measures[j], "+ gender")), data = to1po2)
  coef_gender <- summary(fit_gender)
  row_index_gender <- (j * 2) - 1
  std_beta_gender <- calc_standardized_beta(fit_gender, to1po2, BA_measures[j])
  HR_BA_ns_othe[row_index_gender, c(4, 5, 9, 12)] <- c(coef_gender$coefficients[1, c(1, 3, 5)], coef_gender$concordance[1])
  HR_BA_ns_othe[row_index_gender, 6:8] <- coef_gender$conf.int[1, c(1, 3, 4)]
  HR_BA_ns_othe[row_index_gender, 10] <- cox.zph(fit_gender)$table[1, 3]
  HR_BA_ns_othe[row_index_gender, 11] <- cox.zph(fit_gender)$table[3, 3]
  HR_BA_ns_othe[row_index_gender, "N"] <- coef_gender$n
  HR_BA_ns_othe[row_index_gender, "std_beta"] <- std_beta_gender
  
  # Multivariable model
  fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_other) ~", BA_measures[j], "+ gender + income_bins + NewUtbNiva")), data = to1po2)
  coef_multivariable <- summary(fit_multivariable)
  row_index_multivariable <- j * 2
  std_beta_multivariable <- calc_standardized_beta(fit_multivariable, to1po2, BA_measures[j])
  HR_BA_ns_othe[row_index_multivariable, c(4, 5, 9, 12)] <- c(coef_multivariable$coefficients[1, c(1, 3, 5)], coef_multivariable$concordance[1])
  HR_BA_ns_othe[row_index_multivariable, 6:8] <- coef_multivariable$conf.int[1, c(1, 3, 4)]
  HR_BA_ns_othe[row_index_multivariable, 10] <- cox.zph(fit_multivariable)$table[1, 3]
  HR_BA_ns_othe[row_index_multivariable, 11] <- cox.zph(fit_multivariable)$table[3, 3]
  HR_BA_ns_othe[row_index_multivariable, "N"] <- coef_multivariable$n
  HR_BA_ns_othe[row_index_multivariable, "std_beta"] <- std_beta_multivariable
}

NS_Othe_results <- HR_BA_ns_othe

# Print the modified HR_BA_adrd data frame
print(HR_BA_ns_othe)
```


Binding
```{r}

# Combine all data frames into one large data frame
combined_df_results <- rbind(
  HR_BA_adrd, 
  HR_BA_s_adrd, 
  HR_BA_ns_adrd,
  HR_BA_alzh, 
  HR_BA_s_alzh, 
  HR_BA_ns_alzh,
  HR_BA_vasc, 
  HR_BA_s_vasc, 
  HR_BA_ns_vasc,
  HR_BA_othe, 
  HR_BA_s_othe,
  HR_BA_ns_othe
)

# View the combined data frame
head(combined_df_results)
```

Forest plot phenoage_res
```{r}

library(ggplot2)
library(dplyr)
library(stringr)

# Assuming the dataframe is named 'your_dataframe'
# Filter for "phenoage_res" and add a unique row identifier combining outcome and model
combined_plot_df <- combined_df_results %>%
  filter(BA == "phenoage_res") %>%
  mutate(unique_id = paste(outcome, model, sep = "_"))

# Creating the combined forest plot
combined_forest_plot <- ggplot(combined_plot_df, aes(y = HR, x = as.factor(unique_id))) +
  geom_point(aes(color = model), size = 3) +
  geom_errorbar(aes(ymin = lb, ymax = ub), width = 0.2, size = 0.7) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 0.7) +
  theme_minimal() +
  labs(title = "PhenoAge Residuals", y = "Hazard Ratio (HR)", x = "Outcome and Model Type") +
  coord_flip() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        axis.title.x = element_blank())

# Display the combined plot
combined_forest_plot

```
Looking at it separately:
```{r}

library(ggplot2)
library(dplyr)
library(stringr)

# Assuming your dataframe is named 'combined_df_results'
# Filter for "phenoage_res" and add a unique row identifier combining outcome and model
combined_plot_df <- combined_df_results %>%
  filter(BA == "phenoage_res") %>%
  mutate(unique_id = paste(outcome, model, sep = "_"))

# Function to create a forest plot
create_forest_plot <- function(data, title_suffix) {
  ggplot(data, aes(y = HR, x = as.factor(unique_id))) +
    geom_point(aes(color = model), size = 3) +
    geom_errorbar(aes(ymin = lb, ymax = ub), width = 0.2, size = 0.7) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 0.7) +
    theme_minimal() +
    labs(title = paste("PhenoAge Residuals -", title_suffix), y = "Hazard Ratio (HR)", x = "Outcome and Model Type") +
    coord_flip() +
    scale_y_continuous(limits = c(0.95, 1.15)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.title.x = element_blank())
}

# Outcomes starting with 'S'
outcomes_start_with_S <- combined_plot_df %>%
  filter(str_starts(outcome, "S"))

forest_plot_S <- create_forest_plot(outcomes_start_with_S, "SveDem")
forest_plot_S

# Outcomes starting with 'E'
outcomes_start_with_E <- combined_plot_df %>%
  filter(str_starts(outcome, "E"))

forest_plot_E <- create_forest_plot(outcomes_start_with_E, "Excluding SveDem")
forest_plot_E

# Outcomes not starting with 'S' or 'E'
outcomes_not_start_with_SE <- combined_plot_df %>%
  filter(!str_starts(outcome, "S") & !str_starts(outcome, "E"))

forest_plot_Others <- create_forest_plot(outcomes_not_start_with_SE, "All")
forest_plot_Others


```


#==========================================
#======== Subgroup analysis ===============
#==========================================
```{r}
p_value_results <- data.frame(
  Variable = character(),
  AgeGroup1 = character(),
  AgeGroup2 = character(),
  P_Value = numeric(),
  stringsAsFactors = FALSE
)
```

## Under 65 vs over 65
ADRD
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA_adrd data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("ADRD_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, ADRD) ~", BA_measures[j], "+ gender")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}
ADRD_agegroup <- HR_BA
# Print the updated HR_BA data frame
print(HR_BA)

```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.696 not significant
```


SveDem ADRD
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("S_ADRD_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_ADRD) ~", BA_measures[j], "+ gender")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

S_ADRD_agegroup <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)

```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.736 not significant
```


Excluding SveDem ADRD
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("NS_ADRD_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_ADRD) ~", BA_measures[j], "+ gender")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

NS_ADRD_agegroup <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.513 not significant 
```
Alzheimers
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("Alzheimers_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Alzheimers) ~", BA_measures[j], "+ gender")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])
    

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}
Alzheimers_agegroup <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.176 not significant
```

SveDem Alzheimers
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("S_Alzheimers_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_Alzheimers) ~", BA_measures[j], "+ gender")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
        # Fit Sex-adjusted model
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

S_Alzheimers_agegroup <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.394 not significant
```

Excluding SveDem Alzheimers
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("NS_Alzheimers_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_Alzheimers) ~", BA_measures[j], "+ gender ")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

NS_Alzheimers_agegroup <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.208 not significant
```

Vascular
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("Vascular_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Vascular) ~", BA_measures[j], "+ gender")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

Vascular_agegroup <- HR_BA
# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.0146 significant
```


SveDem Vascular 
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("S_Vascular_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_Vascular) ~", BA_measures[j], "+ gender ")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

S_Vascular_agegroup <- HR_BA
# Print the updated HR_BA data frame
print(HR_BA)

#Error in solve.default(imat, u) :
#system is computationally singular: reciprocal condition number = 4.0366e-17
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.0841 not significant
```

Excluding SveDem Vascular
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("NS_Vascular_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_Vascular) ~", BA_measures[j], "+ gender ")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

NS_Vascular_agegroup <- HR_BA
# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.0788 not significant
```


Other Dementia
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("Other_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Other) ~", BA_measures[j], "+ gender")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

Other_agegroup <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.4022975 not significant
```

SveDem Other
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("S_Other_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_other) ~", BA_measures[j], "+ gender")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

S_Other_agegroup <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.716 not significant
```

Excluding SveDem Other dementia
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  AgeGroup = rep(c("Under 65", "65 and over"), times = length(BA_measures)),
  model = rep("NS_Other_agegroup", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  # Loop over each BA measure
  for (age_group in c("Under 65", "65 and over")) {
    # Subset data based on age group
    if (age_group == "Under 65") {
      data_subset <- to1po2[to1po2$AgeAtLastDate < 65, ]
    } else {
      data_subset <- to1po2[to1po2$AgeAtLastDate >= 65, ]
    }

    # Fit Sex-adjusted model
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_other) ~", BA_measures[j], "+ gender")), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    if (age_group == "Under 65") {
      row_index <- (j - 1) * 2 + 1
    } else {
      row_index <- j * 2
    }
    
    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[3, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

NS_Other_agegroup <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_under65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "Under 65")
phenoage_over65_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$AgeGroup == "65 and over")

# Extract coefficients and standard errors
beta_under65 <- HR_BA$beta[phenoage_under65_row]
se_under65 <- HR_BA$se[phenoage_under65_row]

beta_over65 <- HR_BA$beta[phenoage_over65_row]
se_over65 <- HR_BA$se[phenoage_over65_row]

# Calculate z-statistic
z <- (beta_under65 - beta_over65) / sqrt(se_under65^2 + se_over65^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

# Add the result to the dataframe
p_value_results <- rbind(p_value_results, data.frame(
    Variable = "phenoage_res",
    AgeGroup1 = "Under 65",
    AgeGroup2 = "65 and over",
    P_Value = p_value
    ))
#0.157 not significant
```

```{r}
print(p_value_results)
#none of them were significant for the multivariable model
```

===
```{r}
# Initialize a dataframe to store gender comparison p-values
gender_p_value_results <- data.frame(
  Variable = character(),
  Gender1 = character(),
  Gender2 = character(),
  P_Value = numeric(),
  stringsAsFactors = FALSE
)
```



## Subgroup per sex
```{r}
# Copy 'gender' to 'new_gender'
to1po2$new_gender <- to1po2$gender
# Check unique values in the original 'gender' column
unique(to1po2$gender)
# Convert 'new_gender' to factor with correct levels
# Assuming the unique values are "1" for men and "2" for women
to1po2$new_gender <- factor(to1po2$new_gender, levels = c("1", "2"), labels = c("Men", "Women"))
# Verify the conversion
table(to1po2$new_gender)
```
ADRD
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("ADRD_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_sex
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, ADRD) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}
ADRD_gender <- HR_BA
# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

#8.32e-05 not significant
```


ADRD SveDem
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("S_ADRD_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_ADRD) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

S_ADRD_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.000708 significant
```

Excluding SveDem ADRD
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("NS_ADRD_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_ADRD) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])
    

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

NS_ADRD_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.00920 significant
```

Alzheimers
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("Alzheimers_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Alzheimers) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

Alzheimers_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.292 not significant
```

Alzheimers SveDem
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("S_Alzheimers_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_Alzheimers) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

S_Alzheimers_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.152 not significant
```

Excluding SveDem Alzheimers
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("NS_Alzheimers_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_Alzheimers) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

NS_Alzheimers_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.893 not significant
```

Vascular
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("Vascular_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Vascular) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

Vascular_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.00120 significant
```

SveDem Vascular
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("S_Vascular_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_Vascular) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

S_Vascular_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.0115 significant
```

Excluding SveDem Vascular
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("NS_Vascular_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_Vascular) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

NS_Vascular_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.0303 not significant
```

Other
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("Other_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, Other) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

Other_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.0742 not significant
```

SveDem Other
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("S_Other_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, S_other) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_gender)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_gender)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

S_Other_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.181 not significant
```

Excluding SveDem Other
```{r}
BA_measures <- c("kdm_res", "phenoage_res", "hd_log_res")

# Initialize HR_BA data frame
HR_BA <- data.frame(
  BA = rep(BA_measures, each = 2),
  Gender = rep(c("Men", "Women"), times = length(BA_measures)),
  model = rep("NS_Other_sex", times = 2 * length(BA_measures)),
  beta = NA, se = NA, HR = NA,
  CI_lower = NA, CI_upper = NA, P_PH_BA = NA, global_p_PH_BA = NA, concordance = NA, N = NA, std_beta = NA
)

for (j in 1:length(BA_measures)) {
  for (gender_group in c("Men", "Women")) {
    # Subset data based on new_gender
    data_subset <- to1po2[to1po2$new_gender == gender_group, ]

    # Fit Cox model for the BA measure (without 'new_gender' as a covariate)
    fit_multivariable <- coxph(as.formula(paste("Surv(AgeAtFirstDate, AgeAtLastDate, NS_other) ~", BA_measures[j])), data = data_subset)
    coef_multivariable <- summary(fit_multivariable)
    std_beta <- calc_standardized_beta(fit_multivariable, data_subset, BA_measures[j])

    # Determine row index for updating HR_BA
    row_index <- if (gender_group == "Men") (j - 1) * 2 + 1 else j * 2

    # Update HR_BA with model results
    HR_BA[row_index, c("beta", "se", "HR")] <- coef_multivariable$coefficients[1, c(1, 3, 2)]
    HR_BA[row_index, c("CI_lower", "CI_upper")] <- coef_multivariable$conf.int[1, c(3, 4)]
    HR_BA[row_index, "P_PH_BA"] <- cox.zph(fit_multivariable)$table[1, 3]
    HR_BA[row_index, "global_p_PH_BA"] <- cox.zph(fit_multivariable)$table[2, 3]
    HR_BA[row_index, "concordance"] <- coef_multivariable$concordance[1]
    HR_BA[row_index, "N"] <- coef_multivariable$n
    HR_BA[row_index, "std_beta"] <- std_beta
  }
}

NS_Other_gender <- HR_BA

# Print the updated HR_BA data frame
print(HR_BA)
```

```{r}
# Assuming the rows corresponding to phenoage_res are correctly ordered in HR_BA
phenoage_men_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Men")
phenoage_women_row <- which(HR_BA$BA == "phenoage_res" & HR_BA$Gender == "Women")

# Extract coefficients and standard errors
beta_men <- HR_BA$beta[phenoage_men_row]
se_men <- HR_BA$se[phenoage_men_row]

beta_women <- HR_BA$beta[phenoage_women_row]
se_women <- HR_BA$se[phenoage_women_row]

# Calculate z-statistic
z <- (beta_men - beta_women) / sqrt(se_men^2 + se_women^2)

# Calculate p-value
p_value <- 2 * (1 - pnorm(abs(z)))

# Output the result
p_value

gender_p_value_results <- rbind(gender_p_value_results, data.frame(
  Variable = "phenoage_res",
  Gender1 = "Men",
  Gender2 = "Women",
  P_Value = p_value
))

# 0.116 not significant
```

Bind the subgroups for agegroup and gender
```{r}
# Add a new column to each data frame indicating the source
ADRD_agegroup$Source <- "ADRD_agegroup"
S_ADRD_agegroup$Source <- "S_ADRD_agegroup"
NS_ADRD_agegroup$Source <- "NS_ADRD_agegroup"
Alzheimers_agegroup$Source <- "Alzheimers_agegroup"
S_Alzheimers_agegroup$Source <- "S_Alzheimers_agegroup"
NS_Alzheimers_agegroup$Source <- "NS_Alzheimers_agegroup"
Vascular_agegroup$Source <- "Vascular_agegroup"
S_Vascular_agegroup$Source <- "S_Vascular_agegroup"
NS_Vascular_agegroup$Source <- "NS_Vascular_agegroup"
Other_agegroup$Source <- "Other_agegroup"
S_Other_agegroup$Source <- "S_Other_agegroup"
NS_Other_agegroup$Source <- "NS_Other_agegroup"

# Combine all data frames into one large data frame
combined_df_agegroup <- rbind(
  ADRD_agegroup, 
  S_ADRD_agegroup, 
  NS_ADRD_agegroup,
  Alzheimers_agegroup, 
  S_Alzheimers_agegroup, 
  NS_Alzheimers_agegroup,
  Vascular_agegroup, 
  S_Vascular_agegroup, 
  NS_Vascular_agegroup,
  Other_agegroup, 
  S_Other_agegroup,
  NS_Other_agegroup
)

# View the combined data frame
head(combined_df_agegroup)



# Add a new column 'Source' to each data frame
ADRD_gender$Source <- "ADRD"
S_ADRD_gender$Source <- "S_ADRD"
NS_ADRD_gender$Source <- "NS_ADRD"
Alzheimers_gender$Source <- "Alzheimers"
S_Alzheimers_gender$Source <- "S_Alzheimers"
NS_Alzheimers_gender$Source <- "NS_Alzheimers"
Vascular_gender$Source <- "Vascular"
S_Vascular_gender$Source <- "S_Vascular"
NS_Vascular_gender$Source <- "NS_Vascular"
Other_gender$Source <- "Other"
S_Other_gender$Source <- "S_Other"
NS_Other_gender$Source <- "NS_Other"

# Combine all data frames into one large data frame
combined_df_gender <- rbind(
  ADRD_gender, 
  S_ADRD_gender, 
  NS_ADRD_gender,
  Alzheimers_gender, 
  S_Alzheimers_gender, 
  NS_Alzheimers_gender,
  Vascular_gender, 
  S_Vascular_gender, 
  NS_Vascular_gender,
  Other_gender, 
  S_Other_gender,
  NS_Other_gender
)

# View the combined data frame
head(combined_df_gender)

```
#================================================================

#==============Forest plots======================================

## Subgroup age 
```{r}
library(ggplot2)
library(dplyr)
library(stringr)

# Filtering and adding a unique row identifier
filtered_df_agegroup <- combined_df_agegroup %>%
  filter(BA == "phenoage_res") %>%
  mutate(unique_id = paste(model, AgeGroup, sep = "_")) %>%
  # Renaming the AgeGroup categories
  mutate(AgeGroup = ifelse(AgeGroup == "Under 65", "Below 65", "65 and Above"))

# Re-check the unique values in the AgeGroup column
unique_values <- unique(filtered_df_agegroup$AgeGroup)
print(unique_values)

# Forest plot with the renamed age groups
forest_plot_agegroup <- ggplot(filtered_df_agegroup, aes(y = HR, x = as.factor(unique_id))) +
  geom_point(aes(color = AgeGroup), size = 3) +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.2, size = 0.7) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 0.7) +
  scale_color_manual(values = c("Below 65" = "darkblue", "65 and Above" = "darkred")) +
  theme_minimal() +
  labs(title = "PhenoAge Residuals - Age Groups", y = "Hazard Ratio (HR)", x = "Outcome and Age Group") +
  coord_flip() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        axis.title.x = element_blank())

# Display the plot
forest_plot_agegroup


```
Checking separatley
```{r}
library(ggplot2)
library(dplyr)
library(stringr)

# Renaming the AgeGroup categories and adding a unique row identifier
filtered_df_agegroup <- combined_df_agegroup %>%
  filter(BA == "phenoage_res") %>%
  mutate(AgeGroup = ifelse(AgeGroup == "Under 65", "Below 65", "65 and Above")) %>%
  mutate(unique_id = paste(model, AgeGroup, sep = "_"))

# Filter for models starting with 'S'
models_start_with_S <- filtered_df_agegroup %>%
  filter(str_starts(model, "S"))

# Filter for models starting with 'N'
models_start_with_N <- filtered_df_agegroup %>%
  filter(str_starts(model, "N"))

# Filter for models not starting with 'S' or 'N'
models_not_start_with_SN <- filtered_df_agegroup %>%
  filter(!str_starts(model, "S") & !str_starts(model, "N"))

# Function to create a forest plot
create_forest_plot <- function(data, title_suffix) {
  ggplot(data, aes(y = HR, x = unique_id)) +
    geom_point(aes(color = AgeGroup), size = 3) +
    geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.2, size = 0.7) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 0.7) +
    scale_color_manual(values = c("Below 65" = "darkblue", "65 and Above" = "darkred")) +
    theme_minimal() +
    labs(title = paste("PhenoAge Residuals -", title_suffix), y = "Hazard Ratio (HR)", x = "Outcome and Age Group") +
    coord_flip() +
    scale_y_continuous(limits = c(0.8, 1.36)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.title.x = element_blank())
}

# Creating and displaying plots
forest_plot_S <- create_forest_plot(models_start_with_S, "SveDem Age Groups")
forest_plot_S

forest_plot_N <- create_forest_plot(models_start_with_N, "Excluding SveDem Age Groups")
forest_plot_N

forest_plot_Others <- create_forest_plot(models_not_start_with_SN, "All Age Groups")
forest_plot_Others


```


## Subgroup sex
```{r}
phenoage_res_gender <- combined_df_gender %>%
  filter(BA == "phenoage_res") 

# Add a unique row identifier combining Model and Gender
phenoage_res_gender <- phenoage_res_gender %>%
  mutate(unique_id = paste(model, Gender, sep = "_"))

# Filter for models not starting with 'S'
models_not_start_with_S <- phenoage_res_gender %>%
  filter(!str_starts(model, "S"))

# Enhanced Forest Plot
forest_plot <- ggplot(phenoage_res_gender, aes(y = HR, x = as.factor(unique_id))) +
  geom_point(aes(color = Gender), size = 3) +  # Increase point size
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.2, size = 0.7) +  # Adjust error bar size
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 0.7) +  # Horizontal reference line at HR = 1
  scale_color_manual(values = c("Men" = "darkblue", "Women" = "darkred")) +  # Custom colors for Gender
  theme_minimal() +
  labs(title = "PhenoAge Residuals - Sex", y = "Hazard Ratio (HR)", x = "Outcome and Sex") +
  coord_flip() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10),  # Adjust text angle and size
        axis.title.x = element_blank())
        #panel.grid.major = element_blank(),  # Remove major grid lines
        #panel.grid.minor = element_blank())  # Remove minor grid lines

# Display the enhanced plot
forest_plot

```
Checking separatley
```{r}
library(ggplot2)
library(dplyr)
library(stringr)

#phenoage_res_gender
phenoage_res_gender <- combined_df_gender %>%
  filter(str_detect(BA, "phenoage_res")) %>%
  mutate(unique_id = paste(model, Gender, sep = "_"))

# Filter for models starting with 'S'
models_start_with_S <- phenoage_res_gender %>%
  filter(str_starts(model, "S"))

# Filter for models starting with 'N'
models_start_with_N <- phenoage_res_gender %>%
  filter(str_starts(model, "N"))

# Filter for models not starting with 'S' or 'N'
models_not_start_with_SN <- phenoage_res_gender %>%
  filter(!str_starts(model, "S") & !str_starts(model, "N"))

# Function to create a forest plot
create_forest_plot <- function(data, title_suffix) {
  ggplot(data, aes(y = HR, x = as.factor(unique_id))) +
    geom_point(aes(color = Gender), size = 3) +
    geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.2, size = 0.7) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 0.7) +
    scale_color_manual(values = c("Men" = "darkblue", "Women" = "darkred")) +
    theme_minimal() +
    labs(title = paste("PhenoAge Residuals -", title_suffix), y = "Hazard Ratio (HR)", x = "Outcome and Sex") +
    coord_flip() +
    scale_y_continuous(limits = c(0.92, 1.18)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.title.x = element_blank())
}

# Creating and displaying plots
forest_plot_S <- create_forest_plot(models_start_with_S, "SveDem Sex")
forest_plot_S

forest_plot_N <- create_forest_plot(models_start_with_N, "Excluding SveDem Sex")
forest_plot_N

forest_plot_Others <- create_forest_plot(models_not_start_with_SN, "All per Sex")
forest_plot_Others

```